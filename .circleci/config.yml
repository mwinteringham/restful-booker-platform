# Java Maven CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2
jobs:
  checkout_code:

    docker:
      - image: circleci/openjdk:14-buster-node-browsers

    environment:
      MAVEN_OPTS: -Xmx3200m

    steps:
      - checkout
      - run:
          command: |
            mkdir ~/tmp
            for folder in `git log --format="" --name-only ${CIRCLE_COMPARE_URL##http*/} | cut -d"/" -f1 | sort -u`; do
              echo "$folder will be built in this run"
              touch ~/tmp/$folder.txt
            done
            extract=`mvn org.apache.maven.plugins:maven-help-plugin:3.1.0:evaluate -Dexpression=project.version -q -DforceStdout`
            version=${extract/SNAPSHOT/$(git rev-parse --short HEAD)}
            touch ~/tmp/$version.tmp
          working_directory: auth
      - save_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/

  run_assets_tests:

    docker:
      - image: circleci/openjdk:14-buster-node-browsers

    steps:
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Startup local proxy
          command: |
            npm install
            npm start &
          working_directory: .utilities/rbp-proxy/local/
      - run:
          command: |
              echo "[BUILDING] Assets"
              npm install
              npm test
              npm run build
              cd ..
              cd api
              if [[ -z "${APPLITOOLS_API_KEY}" ]]; then
                printf "Skipping visual checks because no applitools api key has been set. Assign a key to APPLITOOLS_API_KEY to run visual checks"
                mvn install -Drevision=$(git rev-parse --short HEAD) -Dvisual.skip.test=true
              else
                curl https://saucelabs.com/downloads/sc-4.4.12-linux.tar.gz -o saucelabs.tar.gz
                tar -xzf saucelabs.tar.gz
                cd sc-*
                bin/sc -u ${SAUCE_USERNAME} -k ${SAUCE_ACCESS_KEY} -x https://eu-central-1.saucelabs.com/rest/v1 &
                wget --retry-connrefused --no-check-certificate -T 60 localhost:4445
                cd ..
                mvn install -Drevision=$(git rev-parse --short HEAD)
              fi
          working_directory: assets/js
          environment:
            BROWSER: remote
      - save_cache:
          paths:
            - assets/
          key: v1-dependencies-{{ .Environment.CIRCLE_SHA1 }}-assets

workflows:
  version: 2
  build-test-and-deploy:
    jobs:
      - checkout_code
      - run_assets_tests:
          requires:
            - checkout_code
